<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🎮 Rivals Duo Tournament Signup</title>
  <style>
    /* Reset & base */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #181823, #2b2a45);
      color: #f0f0f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 650px;
      margin: auto;
      background: #282843;
      padding: 30px 25px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3), inset 0 0 10px #40406e;
    }
    h1 {
      color: #ffd43b;
      text-align: center;
      margin-bottom: 15px;
      font-weight: 700;
      font-size: 2rem;
      text-shadow: 0 0 8px #ffd43b88;
    }
    .rules-box {
      background: linear-gradient(135deg, #29294a, #1a1a2e);
      border: 2px solid #ffd43b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 0 20px #ffd43b80, inset 0 0 10px #333;
      animation: pulse-glow 1.5s infinite alternate;
    }
    @keyframes pulse-glow {
      from { box-shadow: 0 0 10px #ffd43b80, inset 0 0 5px #333; }
      to { box-shadow: 0 0 20px #ffd43bcc, inset 0 0 15px #444; }
    }
    .rules-box label {
      display: block;
      margin-bottom: 12px;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .rules-box input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
      vertical-align: middle;
    }
    #acceptBtn {
      width: 100%;
      background: #393962;
      border: none;
      padding: 12px;
      color: #ccc;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 10px;
      cursor: not-allowed;
      opacity: 0.5;
      transition: 0.3s;
      margin-bottom: 20px;
    }
    #acceptBtn.enabled {
      cursor: pointer;
      opacity: 1;
      background: #ffd43b;
      color: #282843;
      box-shadow: 0 0 12px #ffd43baa;
    }
    label {
      margin-top: 18px;
      font-weight: 600;
      font-size: 1rem;
      color: #ddd;
      display: block;
    }
    input[type="text"],
    select {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 8px;
      border: none;
      background: #3a3a6f;
      color: #eee;
      font-size: 1rem;
    }
    input[type="submit"] {
      margin-top: 30px;
      width: 100%;
      background: #ffd43b;
      border: none;
      padding: 15px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      color: #282843;
      cursor: pointer;
      transition: 0.3s;
      position: relative;
    }
    input[type="submit"]:hover:not(:disabled) {
      background: #f9d900;
      box-shadow: 0 0 12px #f9d900aa;
    }
    input[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #999;
    }
    input[type="submit"].loading {
      color: transparent;
    }
    input[type="submit"].loading::after {
      content: "⏳";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      color: #282843;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .honeypot {
      display: none !important;
    }
    #message {
      padding: 12px 20px;
      border-radius: 8px;
      display: none;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 20px;
      text-align: center;
    }
    #message.success {
      background-color: #d4edda;
      color: #1a3b23;
      border: 1px solid #9cd1a6;
    }
    #message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    hr {
      margin: 30px 0;
      border-color: #444;
    }
    @media (max-width: 600px) {
      .container { padding: 20px 15px; }
      h1 { font-size: 1.6rem; }
      input, select, button { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎮 Rivals Duo Tournament</h1>
    
    <div style="text-align: center; margin-bottom: 20px;">
      <a href="brackets" style="color: #ffd43b; text-decoration: none; font-weight: 600; padding: 8px 16px; border: 1px solid #ffd43b; border-radius: 8px; transition: 0.3s; margin: 0 5px;" onmouseover="this.style.background='#ffd43b'; this.style.color='#282843';" onmouseout="this.style.background='transparent'; this.style.color='#ffd43b';">
        🏆 View Brackets
      </a>
      <a href="dashboard.html" style="color: #ffd43b; text-decoration: none; font-weight: 600; padding: 8px 16px; border: 1px solid #ffd43b; border-radius: 8px; transition: 0.3s; margin: 0 5px;" onmouseover="this.style.background='#ffd43b'; this.style.color='#282843';" onmouseout="this.style.background='transparent'; this.style.color='#ffd43b';">
        👥 Team Dashboard
      </a>
      <a href="admin.html" style="color: #666; text-decoration: none; font-size: 0.8rem; margin-left: 15px;">🔧</a>
      <a href="test-dashboard.html" style="color: #666; text-decoration: none; font-size: 0.8rem; margin-left: 10px;" title="API Test Dashboard">🧪</a>
    </div>

    <div class="rules-box" id="rulesBox">
      <h3 style="color:#ffd43b;">⚠️ Rules (Must Read & Agree)</h3>
      <form id="rulesChecklist">
        <label><input type="checkbox" class="rule-check" /> ✔️ Both players must be the same rank.</label>
        <label><input type="checkbox" class="rule-check" /> 🎯 No solo signups — you must enter with a duo.</label>
        <label><input type="checkbox" class="rule-check" /> 🚫 No cheating, macros, or exploiting.</label>
        <label><input type="checkbox" class="rule-check" /> 🧠 No alt accounts or smurfing — play on your main.</label>
        <label><input type="checkbox" class="rule-check" /> 🎁 Each rank has its own bracket & prize.</label>
        <label><input type="checkbox" class="rule-check" /> 💬 Must stay in the Discord during the event.</label>
      </form>
    </div>

    <button id="acceptBtn" disabled>📜 I've Read the Rules</button>

    <form id="signupForm">
      <input type="text" name="extra_field" class="honeypot" autocomplete="off" />

      <label for="discord">💬 Your Discord Username</label>
      <input type="text" id="discord" name="discord" required />

      <label for="roblox">🧑 Your Roblox Username</label>
      <input type="text" id="roblox" name="roblox" required />

      <label for="rank">🏅 Your Rivals Rank</label>
      <select id="rank" name="rank" required>
        <option value="">-- Select Your Rank --</option>
        <option value="Bronze">🥉 Bronze</option>
        <option value="Silver">🥈 Silver</option>
        <option value="Gold">🥇 Gold</option>
        <option value="Platinum">💎 Platinum</option>
        <option value="Diamond">💍 Diamond</option>
        <option value="Onyx">⚫ Onyx</option>
        <option value="Nemesis">🔴 Nemesis</option>
        <option value="Archnemesis">🌟 Archnemesis</option>
      </select>

      <hr />

      <label for="duo_discord">👥 Duo's Discord Username</label>
      <input type="text" id="duo_discord" name="duo_discord" required />

      <label for="duo_roblox">🎮 Duo's Roblox Username</label>
      <input type="text" id="duo_roblox" name="duo_roblox" required />

      <label for="duo_rank">🏅 Duo's Rivals Rank</label>
      <select id="duo_rank" name="duo_rank" required>
        <option value="">-- Select Their Rank --</option>
        <option value="Bronze">🥉 Bronze</option>
        <option value="Silver">🥈 Silver</option>
        <option value="Gold">🥇 Gold</option>
        <option value="Platinum">💎 Platinum</option>
        <option value="Diamond">💍 Diamond</option>
        <option value="Onyx">⚫ Onyx</option>
        <option value="Nemesis">🔴 Nemesis</option>
        <option value="Archnemesis">🌟 Archnemesis</option>
      </select>

      <input type="submit" value="🚀 Sign Up!" />
      
      <!-- Debug info -->
      <div id="debugInfo" style="background: #1a1a2e; color: #ccc; padding: 10px; margin-top: 15px; border-radius: 5px; font-size: 0.9rem; display: none;">
        <strong>🔍 Debug Info:</strong>
        <div id="debugContent">Ready to submit...</div>
        <button type="button" onclick="testFormData()" style="background: #666; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 10px; cursor: pointer;">🧪 Test Form Data</button>
        <button type="button" onclick="clearDebug()" style="background: #666; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 10px; margin-left: 5px; cursor: pointer;">🗑️ Clear Debug</button>
      </div>
    </form>

    <div id="message"></div>
  </div>

  <script>
    let isLoading = false;
    
    const acceptBtn = document.getElementById("acceptBtn");
    const checkboxes = document.querySelectorAll(".rule-check");
    const signupForm = document.getElementById("signupForm");

    // Debounce function to prevent spam
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Debug function to show what's happening
    function updateDebugInfo(message) {
      const debugDiv = document.getElementById('debugInfo');
      const debugContent = document.getElementById('debugContent');
      debugDiv.style.display = 'block';
      debugContent.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
      console.log('DEBUG:', message);
    }

    // Test function to check form data
    function testFormData() {
      updateDebugInfo('🧪 Testing form data collection...');
      
      const formData = {
        discord: document.getElementById("discord").value.trim(),
        roblox: document.getElementById("roblox").value.trim(),
        rank: document.getElementById("rank").value,
        duo_discord: document.getElementById("duo_discord").value.trim(),
        duo_roblox: document.getElementById("duo_roblox").value.trim(),
        duo_rank: document.getElementById("duo_rank").value,
        extra_field: document.querySelector('input[name="extra_field"]').value
      };
      
      updateDebugInfo('📋 Current form data: ' + JSON.stringify(formData, null, 2));
      
      // Check if form inputs are enabled
      const submitButton = signupForm.querySelector('input[type="submit"]');
      updateDebugInfo('🔘 Submit button enabled: ' + !submitButton.disabled);
      updateDebugInfo('📝 Form loading state: ' + isLoading);
      
      // Check rules acceptance
      const allChecked = [...checkboxes].every(box => box.checked);
      updateDebugInfo('✅ All rules checked: ' + allChecked);
      updateDebugInfo('🔒 Accept button disabled: ' + acceptBtn.disabled);
    }

    function clearDebug() {
      document.getElementById('debugContent').innerHTML = 'Debug cleared...';
    }

    // Set loading state for entire form
    function setLoading(loading) {
      isLoading = loading;
      const submitButton = signupForm.querySelector('input[type="submit"]');
      const allInputs = signupForm.querySelectorAll('input:not(.honeypot), select');
      
      if (submitButton) {
        submitButton.disabled = loading;
        submitButton.classList.toggle('loading', loading);
        if (loading) {
          submitButton.style.opacity = '0.6';
          submitButton.style.cursor = 'not-allowed';
        } else {
          submitButton.style.opacity = '';
          submitButton.style.cursor = '';
        }
      }
      
      // Disable/enable all form inputs
      allInputs.forEach(input => {
        input.disabled = loading;
        input.style.opacity = loading ? '0.6' : '';
        input.style.pointerEvents = loading ? 'none' : '';
      });
      
      // Disable accept button during loading
      if (loading) {
        acceptBtn.disabled = true;
        acceptBtn.style.opacity = '0.6';
        acceptBtn.style.pointerEvents = 'none';
      }
    }

    function showMessage(text, type = "success") {
      // Remove existing messages
      const existingMessage = document.querySelector('.status-message');
      if (existingMessage) {
        existingMessage.remove();
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `status-message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 90%;
        text-align: center;
        font-weight: 600;
      `;
      
      document.body.appendChild(messageDiv);
      
      // Trigger fade-in animation
      setTimeout(() => {
        messageDiv.style.opacity = '1';
      }, 10);
      
      // Auto-remove after delay
      const delay = type === 'success' ? 3000 : 5000;
      setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
        }, 300);
      }, delay);
    }

    // Rule checkboxes enable accept button when all checked
    checkboxes.forEach(cb => {
      cb.addEventListener("change", () => {
        if (isLoading) return;
        
        const allChecked = [...checkboxes].every(box => box.checked);
        acceptBtn.disabled = !allChecked;
        if (allChecked) {
          acceptBtn.classList.add("enabled");
          acceptBtn.style.cursor = "pointer";
        } else {
          acceptBtn.classList.remove("enabled");
          acceptBtn.style.cursor = "not-allowed";
        }
      });
    });

    // After accepting rules, enable form inputs & disable accept button
    const debouncedAccept = debounce(() => {
      if (isLoading || acceptBtn.disabled) return;
      
      updateDebugInfo('🎯 Rules accepted, enabling form inputs');
      
      acceptBtn.textContent = "✅ Rules Acknowledged";
      acceptBtn.disabled = true;
      acceptBtn.classList.remove("enabled");
      acceptBtn.style.cursor = "not-allowed";
      signupForm.querySelectorAll("input, select").forEach(el => {
        if (!el.classList.contains("honeypot")) el.disabled = false;
      });
      // Disable rules checkboxes
      checkboxes.forEach(cb => cb.disabled = true);
      // Stop glowing animation on rules box
      document.getElementById("rulesBox").style.animation = "none";
      
      updateDebugInfo('📝 Form inputs are now enabled for signup');
      
      // Smooth scroll to form
      signupForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);

    acceptBtn.addEventListener("click", debouncedAccept);

    // Initially disable form inputs except honeypot
    window.addEventListener("DOMContentLoaded", () => {
      signupForm.querySelectorAll("input, select").forEach(el => {
        if (!el.classList.contains("honeypot")) el.disabled = true;
      });
      
      // Show debug info automatically in development
      updateDebugInfo('✅ Page loaded, form initialized');
      updateDebugInfo('📝 Form inputs disabled until rules accepted');
    });

    const debouncedSubmit = debounce(async (e) => {
      e.preventDefault();
      updateDebugInfo('🚀 Form submission started');
      console.log('🚀 Form submission started');

      if (isLoading) {
        updateDebugInfo('❌ Form submission blocked: already loading');
        console.log('❌ Form submission blocked: already loading');
        return;
      }

      // Honeypot check
      const honeypotValue = signupForm.querySelector('input[name="extra_field"]').value;
      if (honeypotValue !== "") {
        updateDebugInfo('❌ Form submission blocked: honeypot triggered');
        console.log('❌ Form submission blocked: honeypot triggered');
        return;
      }

      updateDebugInfo('✅ Collecting form data...');

      const formData = {
        discord: document.getElementById("discord").value.trim(),
        roblox: document.getElementById("roblox").value.trim(),
        rank: document.getElementById("rank").value,
        duo_discord: document.getElementById("duo_discord").value.trim(),
        duo_roblox: document.getElementById("duo_roblox").value.trim(),
        duo_rank: document.getElementById("duo_rank").value,
        extra_field: "" // honeypot
      };

      console.log('📝 Form data:', formData);
      updateDebugInfo('📝 Form data collected: ' + JSON.stringify(formData));

      // Validation
      if (!formData.discord || !formData.roblox || !formData.rank || 
          !formData.duo_discord || !formData.duo_roblox || !formData.duo_rank) {
        console.log('❌ Form validation failed: missing fields');
        updateDebugInfo('❌ Form validation failed: missing fields');
        showMessage("❌ Please fill in all fields!", "error");
        return;
      }

      if (formData.discord === formData.duo_discord || formData.roblox === formData.duo_roblox) {
        console.log('❌ Form validation failed: duplicate players');
        updateDebugInfo('❌ Form validation failed: duplicate players');
        showMessage("❌ Player names must be different!", "error");
        return;
      }

      if (formData.rank !== formData.duo_rank) {
        console.log('❌ Form validation failed: rank mismatch');
        updateDebugInfo('❌ Form validation failed: rank mismatch');
        showMessage("❌ Both players must have the SAME rank!", "error");
        return;
      }

      console.log('✅ Form validation passed, starting API call');
      updateDebugInfo('✅ Form validation passed, starting API call');
      setLoading(true);

      try {
        console.log('🔄 Submitting form data to /api/signup:', formData);
        updateDebugInfo('🔄 Submitting to /api/signup...');
        
        // Add a small delay to show loading state
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const res = await fetch("/api/signup", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(formData)
        });
        
        console.log('📡 Response received - Status:', res.status, 'OK:', res.ok);
        console.log('📡 Response headers:', [...res.headers.entries()]);
        updateDebugInfo(`📡 Response: ${res.status} ${res.ok ? 'OK' : 'ERROR'}`);
        
        let result;
        const contentType = res.headers.get('content-type');
        console.log('📡 Content-Type:', contentType);
        
        if (contentType && contentType.includes('application/json')) {
          try {
            result = await res.json();
            console.log('📦 Response data:', result);
            updateDebugInfo('📦 Response parsed successfully');
          } catch (parseError) {
            console.error('❌ Failed to parse JSON response:', parseError);
            const textResponse = await res.text();
            console.log('📄 Raw response:', textResponse);
            updateDebugInfo('❌ Failed to parse JSON: ' + parseError.message);
            throw new Error(`Server returned invalid JSON response. Status: ${res.status}`);
          }
        } else {
          const textResponse = await res.text();
          console.log('📄 Non-JSON response:', textResponse);
          updateDebugInfo('📄 Non-JSON response received');
          throw new Error(`Server returned non-JSON response. Status: ${res.status}`);
        }

        if (res.ok && result.success) {
          showMessage(`✅ You're signed up! Your Bracket ID: ${result.bracketId}. Redirecting to dashboard...`, "success");
          
          // Store the bracket ID for automatic login to dashboard
          sessionStorage.setItem('newSignupBracketId', result.bracketId);
          sessionStorage.setItem('teamAuthenticated', 'true');
          sessionStorage.setItem('bracketId', result.bracketId);
          
          // Redirect to dashboard after a delay to show the success message
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 2500);
        } else {
          const errorMessage = result?.error || `Server error (${res.status})`;
          console.error('❌ Main signup failed:', errorMessage);
          
          // Try simple signup as fallback
          console.log('🔄 Trying simple signup fallback...');
          showMessage("⚠️ Main signup failed, trying backup method...", "error");
          
          try {
            const simpleRes = await fetch("/api/signup-simple", {
              method: "POST",
              headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
              },
              body: JSON.stringify(formData)
            });
            
            const simpleResult = await simpleRes.json();
            console.log('📦 Simple signup result:', simpleResult);
            
            if (simpleRes.ok && simpleResult.success) {
              showMessage(`✅ You're signed up! Your Bracket ID: ${simpleResult.bracketId}. Redirecting to dashboard...`, "success");
              
              sessionStorage.setItem('newSignupBracketId', simpleResult.bracketId);
              sessionStorage.setItem('teamAuthenticated', 'true');
              sessionStorage.setItem('bracketId', simpleResult.bracketId);
              
              setTimeout(() => {
                window.location.href = 'dashboard.html';
              }, 2500);
            } else {
              showMessage(`❌ Error: ${simpleResult?.error || errorMessage}`, "error");
            }
          } catch (fallbackError) {
            console.error('❌ Fallback signup also failed:', fallbackError);
            showMessage(`❌ Both signup methods failed. Error: ${errorMessage}`, "error");
          }
        }
      } catch (err) {
        console.error('Fetch error:', err);
        
        let errorMessage = "Unknown error occurred";
        
        if (err.name === 'TypeError' && err.message.includes('fetch')) {
          errorMessage = "Could not connect to server. Please check your internet connection.";
        } else if (err.name === 'SyntaxError') {
          errorMessage = "Server returned invalid response. Please try again.";
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        showMessage(`❌ Error: ${errorMessage}`, "error");
      } finally {
        setLoading(false);
      }
    }, 500);

    signupForm.addEventListener("submit", debouncedSubmit);
  </script>
</body>
</html>
