<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ® Rivals Duo Tournament Signup</title>
  <style>
    /* Reset & base */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #181823, #2b2a45);
      color: #f0f0f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 650px;
      margin: auto;
      background: #282843;
      padding: 30px 25px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3), inset 0 0 10px #40406e;
    }
    h1 {
      color: #ffd43b;
      text-align: center;
      margin-bottom: 15px;
      font-weight: 700;
      font-size: 2rem;
      text-shadow: 0 0 8px #ffd43b88;
    }
    .rules-box {
      background: linear-gradient(135deg, #29294a, #1a1a2e);
      border: 2px solid #ffd43b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 0 20px #ffd43b80, inset 0 0 10px #333;
      animation: pulse-glow 1.5s infinite alternate;
    }
    @keyframes pulse-glow {
      from { box-shadow: 0 0 10px #ffd43b80, inset 0 0 5px #333; }
      to { box-shadow: 0 0 20px #ffd43bcc, inset 0 0 15px #444; }
    }
    .rules-box label {
      display: block;
      margin-bottom: 12px;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .rules-box input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
      vertical-align: middle;
    }
    #acceptBtn {
      width: 100%;
      background: #393962;
      border: none;
      padding: 12px;
      color: #ccc;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 10px;
      cursor: not-allowed;
      opacity: 0.5;
      transition: 0.3s;
      margin-bottom: 20px;
    }
    #acceptBtn.enabled {
      cursor: pointer;
      opacity: 1;
      background: #ffd43b;
      color: #282843;
      box-shadow: 0 0 12px #ffd43baa;
    }
    label {
      margin-top: 18px;
      font-weight: 600;
      font-size: 1rem;
      color: #ddd;
      display: block;
    }
    input[type="text"],
    select {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 8px;
      border: none;
      background: #3a3a6f;
      color: #eee;
      font-size: 1rem;
    }
    input[type="submit"],
    #submitBtn {
      margin-top: 30px;
      width: 100%;
      background: #ffd43b;
      border: none;
      padding: 15px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      color: #282843;
      cursor: pointer;
      transition: 0.3s;
      position: relative;
    }
    input[type="submit"]:hover:not(:disabled),
    #submitBtn:hover:not(:disabled) {
      background: #f9d900;
      box-shadow: 0 0 12px #f9d900aa;
    }
    input[type="submit"]:disabled,
    #submitBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #999;
    }
    input[type="submit"].loading,
    #submitBtn.loading {
      color: transparent;
    }
    input[type="submit"].loading::after,
    #submitBtn.loading::after {
      content: "â³";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      color: #282843;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .honeypot {
      display: none !important;
    }
    #message {
      padding: 12px 20px;
      border-radius: 8px;
      display: none;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 20px;
      text-align: center;
    }
    #message.success {
      background-color: #d4edda;
      color: #1a3b23;
      border: 1px solid #9cd1a6;
    }
    #message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    hr {
      margin: 30px 0;
      border-color: #444;
    }
    @media (max-width: 600px) {
      .container { padding: 20px 15px; }
      h1 { font-size: 1.6rem; }
      input, select, button { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ® Rivals Duo Tournament</h1>
    
    <div style="text-align: center; margin-bottom: 20px;">
      <a href="brackets" style="color: #ffd43b; text-decoration: none; font-weight: 600; padding: 8px 16px; border: 1px solid #ffd43b; border-radius: 8px; transition: 0.3s; margin: 0 5px;" onmouseover="this.style.background='#ffd43b'; this.style.color='#282843';" onmouseout="this.style.background='transparent'; this.style.color='#ffd43b';">
        ğŸ† View Brackets
      </a>
      <a href="dashboard.html" style="color: #ffd43b; text-decoration: none; font-weight: 600; padding: 8px 16px; border: 1px solid #ffd43b; border-radius: 8px; transition: 0.3s; margin: 0 5px;" onmouseover="this.style.background='#ffd43b'; this.style.color='#282843';" onmouseout="this.style.background='transparent'; this.style.color='#ffd43b';">
        ğŸ‘¥ Team Dashboard
      </a>
      <a href="admin.html" style="color: #666; text-decoration: none; font-size: 0.8rem; margin-left: 15px;">ğŸ”§</a>
      <a href="test-dashboard.html" style="color: #666; text-decoration: none; font-size: 0.8rem; margin-left: 10px;" title="API Test Dashboard">ğŸ§ª</a>
    </div>

    <div class="rules-box" id="rulesBox">
      <h3 style="color:#ffd43b;">âš ï¸ Rules (Must Read & Agree)</h3>
      <form id="rulesChecklist">
        <label><input type="checkbox" class="rule-check" /> âœ”ï¸ Both players must be the same rank.</label>
        <label><input type="checkbox" class="rule-check" /> ğŸ¯ No solo signups â€” you must enter with a duo.</label>
        <label><input type="checkbox" class="rule-check" /> ğŸš« No cheating, macros, or exploiting.</label>
        <label><input type="checkbox" class="rule-check" /> ğŸ§  No alt accounts or smurfing â€” play on your main.</label>
        <label><input type="checkbox" class="rule-check" /> ğŸ Each rank has its own bracket & prize.</label>
        <label><input type="checkbox" class="rule-check" /> ğŸ’¬ Must stay in the Discord during the event.</label>
      </form>
    </div>

    <button id="acceptBtn" disabled>ğŸ“œ I've Read the Rules</button>

    <form id="signupForm">
      <input type="text" name="extra_field" class="honeypot" autocomplete="off" />

      <label for="discord">ğŸ’¬ Your Discord Username</label>
      <input type="text" id="discord" name="discord" required />

      <label for="roblox">ğŸ§‘ Your Roblox Username</label>
      <input type="text" id="roblox" name="roblox" required />

      <label for="rank">ğŸ… Your Rivals Rank</label>
      <select id="rank" name="rank" required>
        <option value="">-- Select Your Rank --</option>
        <option value="Bronze">ğŸ¥‰ Bronze</option>
        <option value="Silver">ğŸ¥ˆ Silver</option>
        <option value="Gold">ğŸ¥‡ Gold</option>
        <option value="Platinum">ğŸ’ Platinum</option>
        <option value="Diamond">ğŸ’ Diamond</option>
        <option value="Onyx">âš« Onyx</option>
        <option value="Nemesis">ğŸ”´ Nemesis</option>
        <option value="Archnemesis">ğŸŒŸ Archnemesis</option>
      </select>

      <hr />

      <label for="duo_discord">ğŸ‘¥ Duo's Discord Username</label>
      <input type="text" id="duo_discord" name="duo_discord" required />

      <label for="duo_roblox">ğŸ® Duo's Roblox Username</label>
      <input type="text" id="duo_roblox" name="duo_roblox" required />

      <label for="duo_rank">ğŸ… Duo's Rivals Rank</label>
      <select id="duo_rank" name="duo_rank" required>
        <option value="">-- Select Their Rank --</option>
        <option value="Bronze">ğŸ¥‰ Bronze</option>
        <option value="Silver">ğŸ¥ˆ Silver</option>
        <option value="Gold">ğŸ¥‡ Gold</option>
        <option value="Platinum">ğŸ’ Platinum</option>
        <option value="Diamond">ğŸ’ Diamond</option>
        <option value="Onyx">âš« Onyx</option>
        <option value="Nemesis">ğŸ”´ Nemesis</option>
        <option value="Archnemesis">ğŸŒŸ Archnemesis</option>
      </select>

      <input type="button" value="ğŸš€ Sign Up!" id="submitBtn" style="margin-top: 30px; width: 100%; background: #ffd43b; border: none; padding: 15px; border-radius: 12px; font-weight: 700; font-size: 1.1rem; color: #282843; cursor: pointer; transition: 0.3s; position: relative;" />
    </form>

    <div id="message"></div>
  </div>

  <script>
    let isLoading = false;
    let registrationEnabled = true; // Will be checked from server
    
    const acceptBtn = document.getElementById("acceptBtn");
    const checkboxes = document.querySelectorAll(".rule-check");
    const signupForm = document.getElementById("signupForm");

    // Check if registration is enabled
    async function checkRegistrationStatus() {
      try {
        const response = await fetch('/api/admin-settings', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const result = await response.json();
          const settings = result.settings || {};
          registrationEnabled = settings.registrationEnabled !== false && settings.tournamentStarted !== true;
          
          if (!registrationEnabled) {
            showRegistrationClosed(settings.tournamentStarted);
          }
        }
      } catch (error) {
        console.log('Could not check registration status, assuming enabled');
        // Don't block registration if we can't check status
      }
    }

    // Show registration closed message
    function showRegistrationClosed(tournamentStarted) {
      const container = document.querySelector('.container');
      
      let message, subtitle, backgroundColor, borderColor;
      
      if (tournamentStarted) {
        message = 'ğŸ Tournament in Progress!';
        subtitle = 'Registration is now closed - The tournament has already started! Check the brackets to see the current matches.';
        backgroundColor = 'linear-gradient(135deg, #ff6b35, #f7931e)';
        borderColor = '#cc5500';
      } else {
        message = 'ğŸš« Registration Temporarily Disabled';
        subtitle = 'Registration is currently disabled by administrators. Please check back later or contact an administrator for more information.';
        backgroundColor = 'linear-gradient(135deg, #dc3545, #c82333)';
        borderColor = '#721c24';
      }
      
      const closedNotice = document.createElement('div');
      closedNotice.style.cssText = `
        background: ${backgroundColor};
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        font-size: 1.1rem;
        border: 3px solid ${borderColor};
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        animation: attention-pulse 2s ease-in-out infinite;
      `;
      
      closedNotice.innerHTML = `
        <div style="font-size: 1.5rem; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${message}</div>
        <div style="font-size: 1rem; opacity: 0.95; line-height: 1.4;">${subtitle}</div>
        ${tournamentStarted ? `
          <div style="margin-top: 15px;">
            <a href="brackets" style="
              display: inline-block;
              background: rgba(255,255,255,0.2);
              color: white;
              text-decoration: none;
              padding: 10px 20px;
              border-radius: 8px;
              font-weight: bold;
              transition: 0.3s;
              border: 2px solid rgba(255,255,255,0.3);
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
              ğŸ† View Current Brackets
            </a>
          </div>
        ` : ''}
      `;
      
      // Add CSS animation for attention-grabbing pulse
      if (!document.querySelector('#attention-pulse-style')) {
        const style = document.createElement('style');
        style.id = 'attention-pulse-style';
        style.textContent = `
          @keyframes attention-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
            50% { transform: scale(1.02); box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
          }
        `;
        document.head.appendChild(style);
      }
      
      // Insert after the title but before the navigation
      const title = container.querySelector('h1');
      title.insertAdjacentElement('afterend', closedNotice);
      
      // Disable the entire signup process
      const rulesBox = document.getElementById('rulesBox');
      const acceptButton = document.getElementById('acceptBtn');
      const signupForm = document.getElementById('signupForm');
      
      rulesBox.style.opacity = '0.5';
      rulesBox.style.pointerEvents = 'none';
      acceptButton.style.opacity = '0.3';
      acceptButton.style.pointerEvents = 'none';
      acceptButton.textContent = 'ğŸš« Registration Closed';
      signupForm.style.opacity = '0.5';
      signupForm.style.pointerEvents = 'none';
      
      // Disable all form elements
      signupForm.querySelectorAll('input, select, button').forEach(el => {
        el.disabled = true;
      });
    }

    // Debounce function to prevent spam
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Function to download Bracket ID
    function downloadBracketId(bracketId, teamData) {
      const data = {
        bracketId: bracketId,
        rank: teamData.rank,
        player1: {
          discord: teamData.discord,
          roblox: teamData.roblox
        },
        player2: {
          discord: teamData.duo_discord,
          roblox: teamData.duo_roblox
        },
        registrationDate: new Date().toISOString(),
        important: "âš ï¸ SAVE THIS ID! You need this Bracket ID to access your team dashboard and manage your tournament registration."
      };

      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `bracket-${bracketId}-info.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      URL.revokeObjectURL(url);
    }

    // Function to show download prompt
    function showDownloadPrompt(bracketId, teamData) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;

        const modal = document.createElement('div');
        modal.style.cssText = `
          background: #282843;
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.5);
          text-align: center;
          max-width: 500px;
          width: 90%;
          color: #f0f0f5;
        `;

        modal.innerHTML = `
          <h2 style="color: #ffd43b; margin-bottom: 20px;">ğŸ‰ Registration Successful!</h2>
          <div style="background: #dc3545; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>âš ï¸ IMPORTANT: Save Your Bracket ID</strong><br>
            <div style="font-size: 1.2rem; font-weight: bold; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">${bracketId}</div>
            <small>You need this ID to access your dashboard and manage your registration!</small>
          </div>
          <p style="margin-bottom: 25px;">Would you like to download your team information as a backup file?</p>
          <button id="downloadBtn" style="background: #4CAF50; color: white; border: none; padding: 12px 25px; border-radius: 8px; margin: 5px; cursor: pointer; font-weight: bold;">ğŸ’¾ Yes, Download Backup</button>
          <button id="skipBtn" style="background: #666; color: white; border: none; padding: 12px 25px; border-radius: 8px; margin: 5px; cursor: pointer;">Skip Download</button>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        modal.querySelector('#downloadBtn').addEventListener('click', () => {
          downloadBracketId(bracketId, teamData);
          document.body.removeChild(overlay);
          resolve(true);
        });

        modal.querySelector('#skipBtn').addEventListener('click', () => {
          document.body.removeChild(overlay);
          resolve(false);
        });
      });
    }

    // Set loading state for entire form
    function setLoading(loading) {
      isLoading = loading;
      const submitButton = document.getElementById('submitBtn');
      const allInputs = signupForm.querySelectorAll('input:not(.honeypot), select');
      
      if (submitButton) {
        submitButton.disabled = loading;
        submitButton.classList.toggle('loading', loading);
        if (loading) {
          submitButton.style.opacity = '0.6';
          submitButton.style.cursor = 'not-allowed';
        } else {
          submitButton.style.opacity = '';
          submitButton.style.cursor = '';
        }
      }
      
      // Disable/enable all form inputs
      allInputs.forEach(input => {
        input.disabled = loading;
        input.style.opacity = loading ? '0.6' : '';
        input.style.pointerEvents = loading ? 'none' : '';
      });
      
      // Disable accept button during loading
      if (loading) {
        acceptBtn.disabled = true;
        acceptBtn.style.opacity = '0.6';
        acceptBtn.style.pointerEvents = 'none';
      }
    }

    function showMessage(text, type = "success") {
      // Remove existing messages
      const existingMessage = document.querySelector('.status-message');
      if (existingMessage) {
        existingMessage.remove();
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `status-message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 90%;
        text-align: center;
        font-weight: 600;
      `;
      
      document.body.appendChild(messageDiv);
      
      // Trigger fade-in animation
      setTimeout(() => {
        messageDiv.style.opacity = '1';
      }, 10);
      
      // Auto-remove after delay
      const delay = type === 'success' ? 3000 : 5000;
      setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
        }, 300);
      }, delay);
    }

    // Rule checkboxes enable accept button when all checked
    checkboxes.forEach(cb => {
      cb.addEventListener("change", () => {
        if (isLoading) return;
        
        const allChecked = [...checkboxes].every(box => box.checked);
        acceptBtn.disabled = !allChecked;
        if (allChecked) {
          acceptBtn.classList.add("enabled");
          acceptBtn.style.cursor = "pointer";
        } else {
          acceptBtn.classList.remove("enabled");
          acceptBtn.style.cursor = "not-allowed";
        }
      });
    });

    // After accepting rules, enable form inputs & disable accept button
    const debouncedAccept = debounce(() => {
      if (isLoading || acceptBtn.disabled) return;
      
      acceptBtn.textContent = "âœ… Rules Acknowledged";
      acceptBtn.disabled = true;
      acceptBtn.classList.remove("enabled");
      acceptBtn.style.cursor = "not-allowed";
      signupForm.querySelectorAll("input, select").forEach(el => {
        if (!el.classList.contains("honeypot")) el.disabled = false;
      });
      // Disable rules checkboxes
      checkboxes.forEach(cb => cb.disabled = true);
      // Stop glowing animation on rules box
      document.getElementById("rulesBox").style.animation = "none";
      
      // Smooth scroll to form
      signupForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);

    acceptBtn.addEventListener("click", debouncedAccept);

    // Initially disable form inputs except honeypot
    window.addEventListener("DOMContentLoaded", () => {
      signupForm.querySelectorAll("input, select").forEach(el => {
        if (!el.classList.contains("honeypot")) el.disabled = true;
      });
      
      // Check registration status when page loads
      checkRegistrationStatus();
    });

    const debouncedSubmit = debounce(async (e) => {
      e.preventDefault();
      console.log('ğŸš€ Form submission started');

      if (isLoading) {
        console.log('âŒ Form submission blocked: already loading');
        return;
      }

      // Check if registration is enabled
      if (!registrationEnabled) {
        console.log('âŒ Form submission blocked: registration disabled');
        showMessage("âŒ Registration is currently closed!", "error");
        return;
      }

      // Honeypot check
      const honeypotValue = signupForm.querySelector('input[name="extra_field"]').value;
      if (honeypotValue !== "") {
        console.log('âŒ Form submission blocked: honeypot triggered');
        return;
      }

      const formData = {
        discord: document.getElementById("discord").value.trim(),
        roblox: document.getElementById("roblox").value.trim(),
        rank: document.getElementById("rank").value,
        duo_discord: document.getElementById("duo_discord").value.trim(),
        duo_roblox: document.getElementById("duo_roblox").value.trim(),
        duo_rank: document.getElementById("duo_rank").value,
        extra_field: "" // honeypot
      };

      console.log('ğŸ“ Form data:', formData);

      // Validation
      if (!formData.discord || !formData.roblox || !formData.rank || 
          !formData.duo_discord || !formData.duo_roblox || !formData.duo_rank) {
        console.log('âŒ Form validation failed: missing fields');
        showMessage("âŒ Please fill in all fields!", "error");
        return;
      }

      if (formData.discord === formData.duo_discord || formData.roblox === formData.duo_roblox) {
        console.log('âŒ Form validation failed: duplicate players');
        showMessage("âŒ Player names must be different!", "error");
        return;
      }

      if (formData.rank !== formData.duo_rank) {
        console.log('âŒ Form validation failed: rank mismatch');
        showMessage("âŒ Both players must have the SAME rank!", "error");
        return;
      }

      console.log('âœ… Form validation passed, starting API call');
      setLoading(true);

      try {
        console.log('ğŸ”„ Submitting form data to /api/signup:', formData);
        
        const res = await fetch("/api/signup", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(formData)
        });
        
        console.log('ğŸ“¡ Response received - Status:', res.status, 'OK:', res.ok);
        
        let result;
        const contentType = res.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          try {
            result = await res.json();
            console.log('ğŸ“¦ Response data:', result);
          } catch (parseError) {
            console.error('âŒ Failed to parse JSON response:', parseError);
            throw new Error(`Server returned invalid JSON response. Status: ${res.status}`);
          }
        } else {
          const textResponse = await res.text();
          console.log('ğŸ“„ Non-JSON response:', textResponse);
          throw new Error(`Server returned non-JSON response. Status: ${res.status}`);
        }

        if (res.ok && result.success) {
          // Show download prompt before redirect
          await showDownloadPrompt(result.bracketId, formData);
          
          showMessage(`âœ… Registration complete! Redirecting to your dashboard...`, "success");
          
          // Store the bracket ID for automatic login to dashboard
          sessionStorage.setItem('newSignupBracketId', result.bracketId);
          sessionStorage.setItem('teamAuthenticated', 'true');
          sessionStorage.setItem('bracketId', result.bracketId);
          
          // Redirect to dashboard after a delay
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1500);
        } else {
          const errorMessage = result?.error || `Server error (${res.status})`;
          console.error('âŒ Main signup failed:', errorMessage);
          
          // Show specific error messages for common issues
          if (errorMessage.includes('Registration is currently disabled')) {
            showMessage("âŒ Registration is currently closed by administrators!", "error");
            registrationEnabled = false; // Update local status
            return; // Don't try fallback for disabled registration
          } else if (errorMessage.includes('Tournament has already started')) {
            showMessage("âŒ Registration is closed - Tournament has already started!", "error");
            registrationEnabled = false; // Update local status
            return; // Don't try fallback for started tournament
          } else if (errorMessage.includes('rank is full')) {
            showMessage(`âŒ ${errorMessage}`, "error");
            return; // Don't try fallback for full ranks
          }
          
          // Try simple signup as fallback for other errors
          console.log('ğŸ”„ Trying simple signup fallback...');
          showMessage("âš ï¸ Main signup failed, trying backup method...", "error");
          
          try {
            const simpleRes = await fetch("/api/signup-simple", {
              method: "POST",
              headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
              },
              body: JSON.stringify(formData)
            });
            
            const simpleResult = await simpleRes.json();
            console.log('ğŸ“¦ Simple signup result:', simpleResult);
            
            if (simpleRes.ok && simpleResult.success) {
              // Show download prompt for fallback too
              await showDownloadPrompt(simpleResult.bracketId, formData);
              
              showMessage(`âœ… Registration complete! Redirecting to your dashboard...`, "success");
              
              sessionStorage.setItem('newSignupBracketId', simpleResult.bracketId);
              sessionStorage.setItem('teamAuthenticated', 'true');
              sessionStorage.setItem('bracketId', simpleResult.bracketId);
              
              setTimeout(() => {
                window.location.href = 'dashboard.html';
              }, 1500);
            } else {
              showMessage(`âŒ Error: ${simpleResult?.error || errorMessage}`, "error");
            }
          } catch (fallbackError) {
            console.error('âŒ Fallback signup also failed:', fallbackError);
            showMessage(`âŒ Both signup methods failed. Error: ${errorMessage}`, "error");
          }
        }
      } catch (err) {
        console.error('Fetch error:', err);
        
        let errorMessage = "Unknown error occurred";
        
        if (err.name === 'TypeError' && err.message.includes('fetch')) {
          errorMessage = "Could not connect to server. Please check your internet connection.";
        } else if (err.name === 'SyntaxError') {
          errorMessage = "Server returned invalid response. Please try again.";
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        showMessage(`âŒ Error: ${errorMessage}`, "error");
      } finally {
        setLoading(false);
      }
    }, 500);

    // Add event listeners for form submission
    signupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      debouncedSubmit(e);
    });
    
    // Add click handler to submit button
    document.addEventListener('DOMContentLoaded', () => {
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.addEventListener("click", (e) => {
          e.preventDefault();
          debouncedSubmit(e);
        });
      }
    });
  </script>
</body>
</html>
