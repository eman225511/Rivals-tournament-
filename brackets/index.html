<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üèÜ Tournament Brackets - Rivals Duo Tournament</title>
  <style>
    /* Reset & base */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #181823, #2b2a45);
      color: #f0f0f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #282843;
      padding: 30px 25px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3), inset 0 0 10px #40406e;
    }
    h1 {
      color: #ffd43b;
      text-align: center;
      margin-bottom: 15px;
      font-weight: 700;
      font-size: 2rem;
      text-shadow: 0 0 8px #ffd43b88;
    }
    .nav-links {
      text-align: center;
      margin-bottom: 25px;
    }
    .nav-links a {
      color: #ffd43b;
      text-decoration: none;
      font-weight: 600;
      margin: 0 15px;
      padding: 8px 16px;
      border-radius: 8px;
      transition: 0.3s;
      border: 1px solid transparent;
    }
    .nav-links a:hover {
      background: #ffd43b;
      color: #282843;
      border-color: #ffd43b;
    }
    .loading {
      text-align: center;
      color: #ffd43b;
      font-size: 1.2rem;
      margin: 40px 0;
    }
    .no-teams {
      text-align: center;
      color: #ccc;
      font-size: 1.1rem;
      margin: 40px 0;
      padding: 20px;
      background: #393962;
      border-radius: 10px;
    }
    .bracket-entry {
      border: 2px solid #555;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #29294a, #1a1a2e);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: 0.3s;
    }
    .bracket-entry:hover {
      border-color: #ffd43b;
      box-shadow: 0 0 15px #ffd43b40;
    }
    .bracket-header {
      color: #ffd43b;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 15px;
      text-shadow: 0 0 5px #ffd43b66;
    }
    .player-info {
      background: #3a3a6f;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .player-name {
      font-weight: 600;
      color: #eee;
      font-size: 1.1rem;
    }
    .discord-name {
      color: #bbb;
      font-size: 0.95rem;
      margin-left: 10px;
    }
    .timestamp {
      color: #999;
      font-size: 0.9rem;
      text-align: right;
      margin-top: 10px;
      font-style: italic;
    }
    .download-btn {
      background: #ffd43b;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      margin: 20px auto;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      color: #282843;
      display: block;
      transition: 0.3s;
    }
    .download-btn:hover {
      background: #f9d900;
      box-shadow: 0 0 12px #f9d900aa;
    }
    .rank-badge {
      display: inline-block;
      background: #393962;
      color: #ffd43b;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      margin-left: 10px;
      border: 1px solid #ffd43b;
    }
    @media (max-width: 600px) {
      .container { padding: 20px 15px; }
      h1 { font-size: 1.6rem; }
      .nav-links a { margin: 0 8px; font-size: 0.9rem; }
      .bracket-entry { padding: 15px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèÜ Tournament Brackets</h1>
    
    <div class="nav-links">
      <a href="../index.html">üè† Back to Signup</a>
      <a href="#" onclick="refreshBrackets()">üîÑ Refresh</a>
    </div>

    <button class="download-btn" onclick="downloadJson()" id="downloadBtn" style="display: none;">
      üì• Download Brackets JSON
    </button>

    <div id="loading" class="loading">
      üîÑ Loading brackets...
    </div>

    <div id="brackets-container">
      <!-- Brackets will be loaded here -->
    </div>
  </div>

  <script>
    let bracketsData = null;

    async function loadBrackets() {
      const loading = document.getElementById('loading');
      const container = document.getElementById('brackets-container');
      const downloadBtn = document.getElementById('downloadBtn');
      
      loading.style.display = 'block';
      container.innerHTML = '';
      downloadBtn.style.display = 'none';

      try {
        // Try the primary endpoint first, then fallback
        let response;
        try {
          response = await fetch('/api/brackets');
        } catch (e) {
          response = await fetch('/api/bracket');
        }
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        loading.style.display = 'none';
        bracketsData = data;
        
        if (!data || Object.keys(data).length === 0) {
          container.innerHTML = `
            <div class="no-teams">
              üö´ No teams have signed up yet.<br>
              <small>Teams will appear here once they complete the signup process.</small>
            </div>
          `;
          return;
        }

        downloadBtn.style.display = 'block';
        
        // Group by rank
        const rankGroups = {};
        Object.entries(data).forEach(([id, entry]) => {
          const rank = entry.rank || 'Unknown';
          if (!rankGroups[rank]) {
            rankGroups[rank] = [];
          }
          rankGroups[rank].push({ id, ...entry });
        });

        // Sort ranks by typical ranking order
        const rankOrder = ['Bronze', 'Silver', 'Gold', 'Platinum', 'Diamond', 'Onyx', 'Nemesis', 'Archnemesis'];
        const sortedRanks = Object.keys(rankGroups).sort((a, b) => {
          const aIndex = rankOrder.indexOf(a);
          const bIndex = rankOrder.indexOf(b);
          if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
          if (aIndex === -1) return 1;
          if (bIndex === -1) return -1;
          return aIndex - bIndex;
        });

        let html = '';
        
        sortedRanks.forEach(rank => {
          const teams = rankGroups[rank];
          html += `
            <h2 style="color: #ffd43b; text-align: center; margin: 30px 0 20px 0; font-size: 1.5rem;">
              üèÖ ${rank} Rank Bracket (${teams.length} team${teams.length !== 1 ? 's' : ''})
            </h2>
          `;
          
          teams.forEach(team => {
            html += `
              <div class="bracket-entry">
                <div class="bracket-header">
                  üÜî Bracket ID: ${team.id}
                  <span class="rank-badge">${team.rank}</span>
                </div>
                <div class="player-info">
                  <div class="player-name">
                    üë§ ${team.player1.roblox}
                    <span class="discord-name">(${team.player1.discord})</span>
                  </div>
                </div>
                <div class="player-info">
                  <div class="player-name">
                    üë• ${team.player2.roblox}
                    <span class="discord-name">(${team.player2.discord})</span>
                  </div>
                </div>
                <div class="timestamp">
                  üïí Registered: ${new Date(team.timestamp).toLocaleString()}
                </div>
              </div>
            `;
          });
        });

        container.innerHTML = html;
        
      } catch (error) {
        loading.style.display = 'none';
        container.innerHTML = `
          <div class="no-teams" style="background: #661a1a; border: 1px solid #cc3333;">
            ‚ùå Error loading brackets: ${error.message}<br>
            <small>Please try refreshing the page or contact an administrator.</small>
          </div>
        `;
        console.error('Error loading brackets:', error);
      }
    }

    function refreshBrackets() {
      loadBrackets();
    }

    function downloadJson() {
      if (!bracketsData) return;
      
      const jsonString = JSON.stringify(bracketsData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `tournament-brackets-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      URL.revokeObjectURL(url);
    }

    // Load brackets when page loads
    window.addEventListener('DOMContentLoaded', loadBrackets);
  </script>
</body>
</html>
